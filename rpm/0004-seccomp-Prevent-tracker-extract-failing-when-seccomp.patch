From 6f834c20e2b9bf650e6a8119a700b9ecda60b526 Mon Sep 17 00:00:00 2001
From: Andrew Branson <andrew.branson@jolla.com>
Date: Fri, 28 Aug 2020 00:04:51 +0200
Subject: [PATCH] [seccomp] Prevent tracker-extract failing when seccomp
 loading fails on older kernels. JB#50862

---
 src/libtracker-miners-common/tracker-seccomp.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/src/libtracker-miners-common/tracker-seccomp.c b/src/libtracker-miners-common/tracker-seccomp.c
index c0327eb08..dbaf5c991 100644
--- a/src/libtracker-miners-common/tracker-seccomp.c
+++ b/src/libtracker-miners-common/tracker-seccomp.c
@@ -220,11 +220,16 @@ tracker_seccomp_init (void)
 #endif
 
 	g_debug ("Loading seccomp rules.");
-
-	if (seccomp_load (ctx) >= 0) {
+	int rv = seccomp_load (ctx);
+	if (rv >= 0) {
 		/* Any seccomp filters loaded into the kernel are not affected. */
 		seccomp_release (ctx);
 		return TRUE;
+	} else if (rv == -EINVAL) {
+		/* Not supported, continue anyway */
+		g_critical ("Seccomp-bpf not supported by host. Continuing without seccomp filters.");
+		seccomp_release (ctx);
+		return TRUE;
 	}
 
 out:
-- 
2.28.0

