From b4232d86c9d36c38cd4a78f2d797f71963c4d14d Mon Sep 17 00:00:00 2001
From: Andrew Branson <andrew.branson@jolla.com>
Date: Fri, 28 Aug 2020 00:04:51 +0200
Subject: [PATCH 3/4] Prevent tracker-extract failing when seccomp loading
 fails on older kernels. JB#50862

---
 src/libtracker-miners-common/tracker-seccomp.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/src/libtracker-miners-common/tracker-seccomp.c b/src/libtracker-miners-common/tracker-seccomp.c
index f8be94924..2fc65df2f 100644
--- a/src/libtracker-miners-common/tracker-seccomp.c
+++ b/src/libtracker-miners-common/tracker-seccomp.c
@@ -267,11 +267,16 @@ tracker_seccomp_init (void)
 #endif
 
 	g_debug ("Loading seccomp rules.");
-
-	if (seccomp_load (ctx) >= 0) {
+	int rv = seccomp_load (ctx);
+	if (rv >= 0) {
 		/* Any seccomp filters loaded into the kernel are not affected. */
 		seccomp_release (ctx);
 		return TRUE;
+	} else if (rv == -EINVAL) {
+		/* Not supported, continue anyway */
+		g_critical ("Seccomp-bpf not supported by host. Continuing without seccomp filters.");
+		seccomp_release (ctx);
+		return TRUE;
 	}
 
 out:
-- 
2.30.2

